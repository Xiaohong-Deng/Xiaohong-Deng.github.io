<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Shawn's Den, Curiosity and Audacity">

        <link rel="alternate"  href="https://shawnsden.ga/feeds/all.atom.xml" type="application/atom+xml" title="Shawn's Den Full Atom Feed"/>

        <title>Rails ActionMailer: Explain Why Calling Class Methods That Do Not Exist on Mailers Works // Shawn's Den // Curiosity and Audacity</title>


    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.3.0/pure-min.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.1.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://shawnsden.ga/theme/css/pure.css">
    <link rel="stylesheet" href="https://shawnsden.ga/theme/css/monokai.css">

    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/fitvids/1.0.1/jquery.fitvids.min.js"></script>
    <script>
        $(document).ready(function(){
            $(".content").fitVids();
        });
    </script>
</head>

<body>
<div class="pure-g-r" id="layout">
    <div class="sidebar sidebar-article pure-u">
        <header class="header-article">
            <hgroup>
                <a href="https://shawnsden.ga/author/xiaohong-deng.html" title="See posts by Xiaohong Deng">
                        <img class="avatar" alt="Xiaohong Deng" src="https://www.gravatar.com/avatar/db05d7ab1c2addcd23f526774e8f6a1d">
                </a>
                <h2 class="article-info">Xiaohong Deng</h2>
                <small class="about-author">I am super awesome</small>
                <h5>Published</h5>
                <p>六 01 七月 2017</p>
                <a href="/">&larr;Home</a>
            </hgroup>
        </header>
    </div>
    <div class="pure-u">
        <div class="content">
            <section class="post">
                <header class="post-header">
                    <h1>Rails ActionMailer: Explain Why Calling Class Methods That Do Not Exist on Mailers Works</h1>
                        <p class="post-meta">
                            // under                                 <a class="post-category" href="https://shawnsden.ga/tag/rails.html">rails</a>
                        </p>
                </header>
            </section>
            <!-- Summary: -->

<p>Here is <a href="http://karolgalanciak.com/blog/2016/07/31/decoding-rails-magic-how-does-calling-class-methods-on-mailers-work">an article</a> from Karol Galanciak you can refer to as a start. I'm gonna rewrite his article in a way that conveys pretty much the same information with addditional detail generated by me reading the Rails source code. Hopefully it would crystalize your understanding on the subject further. Most of the code snippets are snatched from Michael Hartl's Rails Tutorial</p>
<p>In a Rails app, you generate a Mailer by typing the following in the terminal</p>
<p><code>rails g mailer UserMailer account_activation</code></p>
<p>Inside <code>user_mailer.rb</code> you have</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">UserMailer</span> <span class="o">&lt;</span> <span class="no">ApplicationMailer</span>
  <span class="k">def</span> <span class="nf">account_activation</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="n">user</span>
    <span class="n">mail</span> <span class="ss">to</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="ss">subject</span><span class="p">:</span> <span class="s2">&quot;Account activation&quot;</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>


<p>After that you can send email to <code>user</code> by</p>
<p><code>UserMailer.account_activation(user).deliver_now</code></p>
<p>You can preview the mail in <code>user_mailer_preview</code> by the following</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">UserMailerPreview</span> <span class="o">&lt;</span> <span class="no">ActionMailer</span><span class="o">::</span><span class="no">Preview</span>

  <span class="c1"># Preview this email at http://localhost:3000/rails/mailers/user_mailer/account_activation</span>
  <span class="k">def</span> <span class="nf">account_activation</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">first</span>
    <span class="n">user</span><span class="o">.</span><span class="n">activation_token</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new_token</span>
    <span class="c1"># account_activation is an instance method</span>
    <span class="c1"># of UserMailer. What&#39;s going on?</span>
    <span class="no">UserMailer</span><span class="o">.</span><span class="n">account_activation</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
  <span class="k">end</span>
</pre></div>


<p>You can create a <code>user_mailer_test.rb</code> and do the following</p>
<div class="highlight"><pre><span></span><span class="nb">require</span> <span class="s1">&#39;test_helper&#39;</span>

<span class="k">class</span> <span class="nc">UserMailerTest</span> <span class="o">&lt;</span> <span class="no">ActionMailer</span><span class="o">::</span><span class="no">TestCase</span>

  <span class="nb">test</span> <span class="s2">&quot;account_activation&quot;</span> <span class="k">do</span>
    <span class="n">mail</span> <span class="o">=</span> <span class="no">UserMailer</span><span class="o">.</span><span class="n">account_activation</span>
    <span class="n">assert_equal</span> <span class="s2">&quot;Account activation&quot;</span><span class="p">,</span> <span class="n">mail</span><span class="o">.</span><span class="n">subject</span>
    <span class="n">assert_equal</span> <span class="o">[</span><span class="s2">&quot;to@example.org&quot;</span><span class="o">]</span><span class="p">,</span> <span class="n">mail</span><span class="o">.</span><span class="n">to</span>
    <span class="n">assert_equal</span> <span class="o">[</span><span class="s2">&quot;from@example.com&quot;</span><span class="o">]</span><span class="p">,</span> <span class="n">mail</span><span class="o">.</span><span class="n">from</span>
    <span class="n">assert_match</span> <span class="s2">&quot;Hi&quot;</span><span class="p">,</span> <span class="n">mail</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">encoded</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>


<h2>Why <code>account_activation</code> Is Defined as An Instance Method But Called as A Class Method?</h2>
<p>You'd probably have guessed <code>method_missing</code> is behind the curtain. That's correct. </p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Base</span>
  <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
  <span class="o">...</span>
    <span class="k">def</span> <span class="nf">method_missing</span><span class="p">(</span><span class="n">method_name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">action_methods</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">method_name</span><span class="o">.</span><span class="n">to_s</span><span class="p">)</span>
        <span class="no">MessageDelivery</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="n">method_name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="k">super</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="o">...</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>


<p>Calling the instance method as a class method results in a <code>MessageDelivery</code> object. <code>MessageDelivery</code> is a subclass of <code>Delegator</code>. It's a wrapper of the related object. In this case Mail::Message. You can retrieve the wrapped object by <code>md.message</code> given <code>md</code> is a <code>MessageDelivery</code> object. The Mailer class, in this case <code>UserMailer</code>, instance method <code>account_activation</code> and arg <code>user</code> are passed to the <code>MessageDelivery</code> object.</p>
<p>Note that <code>action_methods</code> is inherited from <code>AbstractController::Base</code>. <code>method_missing</code> here is defined in singleton class. The scope in singleton class is the class itself. So <code>method_missing</code> handles class methods.</p>
<p>Returning a <code>MessageDelivery</code> object doesn't quite answer the question, does it? What about instance method <code>account_activation</code>? Does it get called somewhere?</p>
<h2>What Does <code>MessageDelivery#deliver_now</code> Do</h2>
<p>First, we have</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">deliver_now</span>
  <span class="n">processed_mailer</span><span class="o">.</span><span class="n">handle_exceptions</span> <span class="k">do</span>
    <span class="n">message</span><span class="o">.</span><span class="n">deliver</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>


<p>Note <code>message</code> in the code is called on an instance of <code>MessageDelivery</code>. Though internally it is a delegator of <code>processed_mailer</code>. That is, <code>deliver</code> is actually called on <code>processed_mailer.message</code>. <code>message</code> is an <code>attr_internal</code>.</p>
<p>Let's look into <code>processed_mailer</code> method</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">processed_mailer</span>
  <span class="vi">@processed_mailer</span> <span class="o">||=</span> <span class="vi">@mailer_class</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">tap</span> <span class="k">do</span> <span class="o">|</span><span class="n">mailer</span><span class="o">|</span>
    <span class="n">mailer</span><span class="o">.</span><span class="n">process</span> <span class="vi">@action</span><span class="p">,</span> <span class="o">*</span><span class="vi">@args</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>


<p>Here <code>@mailer_class</code> is <code>UserMailer</code> in our case. <code>tap</code> is defiend in <code>Object</code> as follows</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Object</span>
  <span class="k">def</span> <span class="nf">tap</span>
    <span class="k">yield</span> <span class="nb">self</span>
    <span class="nb">self</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>


<p>So <code>processed_mailer</code> is equivalent to</p>
<div class="highlight"><pre><span></span><span class="n">mailer</span> <span class="o">=</span> <span class="vi">@mailer_class</span><span class="o">.</span><span class="n">new</span>
<span class="n">mailer</span><span class="o">.</span><span class="n">process</span> <span class="vi">@action</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span>
<span class="vi">@processed_mailer</span> <span class="o">||=</span> <span class="n">mailer</span>
</pre></div>


<p>I won't dig into <code>process</code> deeper because it is quite involved. I assume process executes the instance method on the <code>UserMailer</code> object. Almost all instance methods of <code>MessageDelivery</code> call <code>processed_mailer</code> internally. That more or less answers the question that if <code>account_activation</code> gets called somewhere?</p>
<h2>Why Preview Can Show Mail Content by Returning a <code>MessageDelivery</code> Object</h2>
<p>I can only guess that by visiting the URL specified above the method, some instance methods get triggered on the returned <code>MessageDelivery</code> object.</p>
<h2>Why Methods <code>to</code>, <code>from</code> and <code>subject</code> Can Be Called on <code>MessageDelivery</code> Object</h2>
<p>You guessed it again, <code>method_missing</code>! This time it's the <code>method_missing</code> inherited from <code>Delegator</code>. It calls <code>__getobj__</code> which calls <code>message</code> on <code>MessageDelivery</code> object and returns the wrapped object, <code>Mail::Message</code>. It has methods <code>to</code>, <code>from</code> and <code>subject</code>.</p>
<h2>Wrap Up</h2>
<p>That's it. That is our little tour of visiting some Mailer related Rails source code. Hope that resolves your confusion to some extent.</p>
            <div class="hr"></div>
            <a href="#" class="go-top">Go Top</a>
<div class="comments">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = "shawnsden"; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div><footer class="footer">
    <p>&copy; Shawn's Den &ndash;
        Built with <a href="https://github.com/PurePelicanTheme/pure">Pure Theme</a>
        for <a href="http://blog.getpelican.com/">Pelican</a>
    </p>
</footer>        </div>
    </div>
</div>
    <script>
        var $top = $('.go-top');

        // Show or hide the sticky footer button
        $(window).scroll(function() {
            if ($(this).scrollTop() > 200) {
                $top.fadeIn(200);
            } else {
                $top.fadeOut(200);
            }
        });

        // Animate the scroll to top
        $top.click(function(event) {
            event.preventDefault();
            $('html, body').animate({scrollTop: 0}, 300);
        })

        // Makes sure that the href="#" attached to the <a> elements
        // don't scroll you back up the page.
        $('body').on('click', 'a[href="#"]', function(event) {
            event.preventDefault();
        });
    </script>
</body>
</html>